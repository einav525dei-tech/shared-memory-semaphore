#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <unistd.h>
#include <sys/wait.h>
#include <string.h>
#include <semaphore.h>

#define SHM_NAME "/my_shared_mem"
#define SEM_NAME "/my_semaphore"
#define SHM_SIZE 64

int main() {
    int shm_fd;
    char *shm_ptr;
    sem_t *sem;

    // יצירת הזיכרון המשותף
    shm_fd = shm_open(SHM_NAME, O_CREAT | O_RDWR, 0600);
    if (shm_fd == -1) {
        perror("shm_open");
        exit(EXIT_FAILURE);
    }

    if (ftruncate(shm_fd, SHM_SIZE) == -1) {
        perror("ftruncate");
        exit(EXIT_FAILURE);
    }

    shm_ptr = mmap(NULL, SHM_SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, shm_fd, 0);
    if (shm_ptr == MAP_FAILED) {
        perror("mmap");
        exit(EXIT_FAILURE);
    }

    // יצירת סמפור
    sem = sem_open(SEM_NAME, O_CREAT | O_EXCL, 0600, 1);
    if (sem == SEM_FAILED) {
        perror("sem_open");
        exit(EXIT_FAILURE);
    }

    pid_t pid1 = fork();
    if (pid1 == -1) {
        perror("fork");
        exit(EXIT_FAILURE);
    }

    if (pid1 == 0) {
        // בן 1: כותב ל־32 בתים ראשונים
        sem_wait(sem);
        strncpy(shm_ptr, "Hello from child 1", 32);
        sem_post(sem);
        exit(EXIT_SUCCESS);
    }

    pid_t pid2 = fork();
    if (pid2 == -1) {
        perror("fork");
        exit(EXIT_FAILURE);
    }

    if (pid2 == 0) {
        // בן 2: כותב ל־32 בתים האחרונים
        sem_wait(sem);
        strncpy(shm_ptr + 32, "Hello from child 2", 32);
        sem_post(sem);
        exit(EXIT_SUCCESS);
    }

    // אב: ממתין לשני הבנים
    wait(NULL);
    wait(NULL);

    // הדפסת התוצאה
    printf("Parent reads:\n");
    printf("  Part 1: %s\n", shm_ptr);
    printf("  Part 2: %s\n", shm_ptr + 32);

    // ניקוי משאבים
    munmap(shm_ptr, SHM_SIZE);
    close(shm_fd);
    shm_unlink(SHM_NAME);

    sem_close(sem);
    sem_unlink(SEM_NAME);

    return 0;
}
